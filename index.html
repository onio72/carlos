<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Recursos para Carlos - 1¬∫ ESO</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    :root{
      --primary:#667eea;--primary-dark:#5a67d8;--secondary:#764ba2;--accent:#f093fb;
      --bg-light:#f7fafc;--bg-white:#ffffff;--text-dark:#2d3748;--text-light:#718096;
      --shadow:0 10px 25px rgba(0,0,0,0.1);--shadow-hover:0 20px 40px rgba(0,0,0,0.15);
      --border-radius:16px;--success:#48bb78;--warning:#ed8936;--error:#f56565;
    }
    body{font-family:'Poppins',sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;color:var(--text-dark);line-height:1.6}
    .hero{text-align:center;padding:3rem 1rem 1rem;color:#fff;position:relative;overflow:hidden}
    .hero::before{content:'';position:absolute;inset:0;background:url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="%23ffffff" fill-opacity="0.1"/><circle cx="75" cy="75" r="1" fill="%23ffffff" fill-opacity="0.08"/><circle cx="50" cy="10" r="0.5" fill="%23ffffff" fill-opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');opacity:.3}
    .hero-content{position:relative;z-index:1}
    .hero h1{font-size:2.2rem;font-weight:700;margin-bottom:.3rem;text-shadow:0 4px 20px rgba(0,0,0,0.3)}
    .hero p{font-size:1rem;font-weight:300;opacity:.9}
    .container{max-width:1200px;margin:0 auto;padding:0 1rem}
    .app-container{background:var(--bg-white);border-radius:var(--border-radius);box-shadow:var(--shadow);margin:-20px 1rem 3rem;position:relative;z-index:2;overflow:hidden}
    .quick-stats{display:flex;justify-content:center;gap:2rem;padding:1rem;background:rgba(255,255,255,.05);backdrop-filter:blur(10px);margin:1rem 0}
    .stat-item{text-align:center;color:#fff}
    .stat-number{font-size:1.6rem;font-weight:700;display:block}
    .stat-label{font-size:.85rem;opacity:.8;font-weight:300}

    /* Buscadores */
    .search-container{padding:1rem 1.5rem;background:var(--bg-light);border-bottom:1px solid #e2e8f0}
    .search-input{width:100%;padding:.9rem;border:2px solid transparent;border-radius:25px;background:#fff;font-size:1rem;transition:all .3s ease;box-shadow:0 2px 10px rgba(0,0,0,.05)}
    .search-input:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(102,126,234,.1)}

    /* Grid materias */
    .subjects-overview{padding:1.5rem;display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:1rem}
    .subject-card{background:var(--bg-light);border-radius:12px;padding:1.2rem;text-align:center;cursor:pointer;transition:all .3s ease;border:3px solid transparent;position:relative;overflow:hidden}
    .subject-card:hover{transform:translateY(-4px);background:#fff;border-color:var(--primary);box-shadow:0 8px 25px rgba(102,126,234,.15)}
    .subject-icon{font-size:2.3rem;margin-bottom:.6rem;display:block}
    .subject-title{font-size:1.15rem;font-weight:600;color:var(--text-dark);margin-bottom:.2rem}
    .subject-subtitle{font-size:.85rem;color:var(--text-light);font-weight:300}
    .subject-count{display:inline-block;margin-top:.4rem;background:var(--primary);color:#fff;padding:.15rem .7rem;border-radius:20px;font-size:.78rem;font-weight:500}

    /* Detalle */
    .subject-detail{display:none}
    .detail-header{background:linear-gradient(135deg,var(--primary),var(--secondary));color:#fff;padding:1.5rem;position:relative}
    .back-button{display:inline-flex;align-items:center;gap:.5rem;background:rgba(255,255,255,.2);color:#fff;border:none;padding:.6rem 1.2rem;border-radius:25px;cursor:pointer;font-size:.9rem;transition:all .3s ease;margin-bottom:.8rem}
    .back-button:hover{background:rgba(255,255,255,.3);transform:translateX(-2px)}
    .detail-title{font-size:1.7rem;font-weight:600;margin-bottom:.3rem;display:flex;align-items:center;gap:.7rem}
    .detail-subtitle{font-size:.95rem;opacity:.85;font-weight:300}

    .topics-container{padding:1.2rem}
    .topic-section{margin-bottom:1.4rem;background:var(--bg-light);border-radius:12px;padding:1rem}
    .topic-title{font-size:1.05rem;font-weight:600;color:var(--primary);margin-bottom:.8rem;padding-bottom:.5rem;border-bottom:2px solid var(--primary)}
    .resources-grid{display:grid;gap:.7rem}
    .resource-link{display:flex;align-items:center;padding:.9rem;background:#fff;border-radius:10px;text-decoration:none;color:var(--text-dark);transition:all .2s ease;border:2px solid transparent;box-shadow:0 2px 8px rgba(0,0,0,.05)}
    .resource-link:hover{transform:translateX(3px);border-color:var(--primary);box-shadow:0 8px 20px rgba(102,126,234,.12)}
    .resource-text{flex:1}
    .resource-title{font-weight:500;color:var(--text-dark);margin-bottom:.2rem;font-size:1rem}
    .resource-description{font-size:.85rem;color:var(--text-light);line-height:1.35}

    @media (max-width:768px){
      .hero h1{font-size:1.8rem}
      .subjects-overview{grid-template-columns:1fr}
    }
    .subject-card:focus,.resource-link:focus,.back-button:focus{outline:3px solid var(--primary);outline-offset:2px}
    @media (prefers-color-scheme: dark){
      :root{--bg-white:#1a202c;--bg-light:#2d3748;--text-dark:#f7fafc;--text-light:#a0aec0;}
    }
  </style>
</head>
<body>
  <section class="hero">
    <div class="hero-content">
      <h1>Recursos para Carlos</h1>
      <p>1¬∫ ESO - Portal de aprendizaje interactivo</p>
    </div>
  </section>

  <div class="container">
    <div class="app-container">

      <!-- Stats -->
      <div class="quick-stats">
        <div class="stat-item"><span class="stat-number" id="total-subjects">0</span><span class="stat-label">Materias</span></div>
        <div class="stat-item"><span class="stat-number" id="total-resources">0</span><span class="stat-label">Recursos</span></div>
        <div class="stat-item"><span class="stat-number" id="total-topics">0</span><span class="stat-label">Temas</span></div>
      </div>

      <!-- Buscador portada -->
      <div class="search-container" id="home-search">
        <input type="text" id="search-input-home" class="search-input" placeholder="Buscar materias..." aria-label="Buscar materias">
      </div>

      <!-- Vista principal: Materias -->
      <div id="subjects-overview" class="subjects-overview" aria-live="polite"></div>

      <!-- Vista detalle -->
      <div id="subject-detail" class="subject-detail" aria-live="polite">
        <div class="detail-header">
          <button id="back-button" class="back-button" type="button" aria-label="Volver a materias">‚Üê Volver a materias</button>
          <h2 class="detail-title">
            <span id="detail-icon">üìö</span>
            <div>
              <div id="detail-title-text">Materia</div>
              <div class="detail-subtitle" id="detail-subtitle-text">Subt√≠tulo</div>
            </div>
          </h2>
        </div>
        <div class="search-container">
          <input type="text" id="search-input" class="search-input" placeholder="Buscar recursos de esta materia..." aria-label="Buscar recursos">
        </div>
        <div id="topics-container" class="topics-container"></div>
      </div>
    </div>
  </div>

  <script>
    /* ============================
       CONFIG FIJA DE 9 MATERIAS
       ============================ */
    const DEFAULT_CATEGORIES = [
      { id:'geografia', title:'Geograf√≠a e Historia', icon:'üåç', subtitle:'', visible:true },
      { id:'matematicas', title:'Matem√°ticas', icon:'üî¢', subtitle:'', visible:true },
      { id:'lengua', title:'Lengua', icon:'üìö', subtitle:'', visible:true },
      { id:'biologia', title:'Biolog√≠a', icon:'üß¨', subtitle:'', visible:true },
      { id:'ingles', title:'Ingl√©s', icon:'üá¨üáß', subtitle:'', visible:true },
      { id:'frances', title:'Franc√©s', icon:'üá´üá∑', subtitle:'', visible:true },
      { id:'musica', title:'M√∫sica', icon:'üéµ', subtitle:'', visible:true },
      { id:'epv', title:'Educaci√≥n Pl√°stica y Visual', icon:'üé®', subtitle:'', visible:true },
      { id:'ef', title:'Educaci√≥n F√≠sica', icon:'üèÉ', subtitle:'', visible:true }
    ];

    /* ============================
       ESTADO
       ============================ */
    let DATA = { categories: [] };             // se rellenar√° con merge
    let currentView = 'overview';
    let currentSubject = null;
    let filteredResources = [];
    let homeQuery = '';

    /* ============================
       ELEMENTOS
       ============================ */
    const $subjectsOverview = document.getElementById('subjects-overview');
    const $subjectDetail = document.getElementById('subject-detail');
    const $backButton = document.getElementById('back-button');
    const $searchInput = document.getElementById('search-input');
    const $homeSearchInput = document.getElementById('search-input-home');
    const $topicsContainer = document.getElementById('topics-container');
    const $detailIcon = document.getElementById('detail-icon');
    const $detailTitleText = document.getElementById('detail-title-text');
    const $detailSubtitleText = document.getElementById('detail-subtitle-text');

    /* ============================
       UTILIDADES
       ============================ */
    function el(tag, attrs = {}, children = []) {
      const node = document.createElement(tag);
      for (const [k, v] of Object.entries(attrs)) {
        if (k === 'class') node.className = v;
        else if (k === 'html') node.innerHTML = v;
        else if (k.startsWith('on')) node.addEventListener(k.slice(2), v);
        else node.setAttribute(k, v);
      }
      (Array.isArray(children) ? children : [children]).forEach(c => {
        if (c == null) return;
        node.appendChild(typeof c === 'string' ? document.createTextNode(c) : c);
      });
      return node;
    }

    function stripRTF(rtfs) {
      if (!rtfs) return '';
      return rtfs
        .replace(/\\par[d]?/g, '\n')
        .replace(/\\'([0-9a-fA-F]{2})/g, (_, hex) => String.fromCharCode(parseInt(hex,16)))
        .replace(/\\u-?\d+\??/g, '')
        .replace(/\\[a-zA-Z]+\d* ?/g, '')
        .replace(/[{}]/g, '')
        .replace(/\s+\n/g, '\n')
        .trim();
    }

    function toBool(v, def=true){
      if (v == null || v === '') return def;
      v = String(v).trim().toLowerCase();
      return ['si','s√≠','true','1','visible','on'].includes(v);
    }

    function parseLineParts(payload){
      return payload.split('|').map(s=>s.trim());
    }

    function topicOrderKey(title){
      // extrae primer n√∫mero para ordenar por Tema 1,2,3...
      const m = String(title).match(/\d+/);
      return m ? parseInt(m[0],10) : Number.POSITIVE_INFINITY;
    }

    /* ============================
       PARSER recursos.txt
       Formato:
       [MATERIA] id | icon | T√≠tulo | Subt√≠tulo | visible=si/no
       [TEMA]     T√≠tulo (p.ej. "Tema 1") | visible=si/no
       [ENLACE]   T√≠tulo | Descripci√≥n | URL
       ============================ */
    function parseRecursos(text) {
      const lines = text.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
      const categories = [];
      let currentCat = null;
      let currentTopic = null;

      function ensureTema1(){
        if (!currentCat) return;
        if (!currentCat.topics.length){
          currentCat.topics.push({ title:'Tema 1', visible:true, resources:[] });
        }
      }

      for (const line of lines) {
        if (line.startsWith('[MATERIA]')) {
          const parts = parseLineParts(line.slice(9));
          const [id, icon, title, subtitle, visKV] = parts;
          const visible = toBool((visKV||'').split('=').slice(1).join('='));
          currentCat = {
            id: (id||'').toLowerCase(),
            icon: icon || '',
            title: title || '',
            subtitle: subtitle || '',
            visible: visKV ? visible : true,
            topics: []
          };
          categories.push(currentCat);
          currentTopic = null;

        } else if (line.startsWith('[TEMA]')) {
          const parts = parseLineParts(line.slice(6));
          const [title, visKV] = parts;
          const visible = toBool((visKV||'').split('=').slice(1).join('='));
          currentTopic = { title: title || 'Tema 1', visible: visKV ? visible : true, resources: [] };
          if (currentCat) currentCat.topics.push(currentTopic);

        } else if (line.startsWith('[ENLACE]')) {
          const parts = parseLineParts(line.slice(8));
          const [rTitle, rDesc, rUrl] = parts;
          if (currentCat){
            if (!currentTopic){
              currentTopic = { title:'Tema 1', visible:true, resources:[] };
              currentCat.topics.push(currentTopic);
            }
            currentTopic.resources.push({
              title: rTitle || 'Recurso',
              description: rDesc || '',
              url: rUrl || '#'
              // SIN icono por requisito
            });
          }
        }
      }
      // Asegura Tema 1 en cada materia con al menos un tema
      categories.forEach(c=>{
        if (!c.topics || !c.topics.length){
          c.topics = [{ title:'Tema 1', visible:true, resources:[] }];
        }
      });
      return { categories };
    }

    /* ============================
       MERGE: 9 materias fijas + archivo
       ============================ */
    function mergeDefaultsWithParsed(parsed){
      const mapParsed = new Map(parsed.categories.map(c=>[c.id, c]));
      const merged = DEFAULT_CATEGORIES.map(base=>{
        const pc = mapParsed.get(base.id);
        const out = {
          id: base.id,
          title: pc?.title || base.title,
          icon: pc?.icon || base.icon,  // un solo icono por materia
          subtitle: pc?.subtitle || base.subtitle || '',
          visible: (pc?.visible ?? base.visible),
          topics: []
        };
        // temas
        const topics = (pc?.topics || [{ title:'Tema 1', visible:true, resources:[] }])
          .map(t=>({
            title: t.title || 'Tema 1',
            visible: (t.visible ?? true),
            resources: (t.resources || []).map(r=>({
              title: r.title, description: r.description, url: r.url
            }))
          }))
          // solo temas visibles
          .filter(t=>t.visible)
          // orden por n√∫mero
          .sort((a,b)=> topicOrderKey(a.title) - topicOrderKey(b.title));

        out.topics = topics;
        return out;
      });

      return { categories: merged };
    }

    /* ============================
       CONTADORES
       ============================ */
    function countResources(category) {
      return category.topics?.reduce((sum, topic) => sum + (topic.resources?.length || 0), 0) || 0;
    }
    function updateStats() {
      document.getElementById('total-subjects').textContent = DATA.categories.length;
      document.getElementById('total-resources').textContent =
        DATA.categories.reduce((sum, cat) => sum + countResources(cat), 0);
      document.getElementById('total-topics').textContent =
        DATA.categories.reduce((sum, cat) => sum + (cat.topics?.length || 0), 0);
    }

    /* ============================
       RENDER PORTADA
       ============================ */
    function renderSubjectCard(category) {
      const resourceCount = countResources(category);
      return el('div', {
        class: 'subject-card',
        tabindex: '0',
        role: 'button',
        onclick: () => showSubjectDetail(category),
        onkeydown: (e)=>{ if(e.key==='Enter'||e.key===' ') showSubjectDetail(category); }
      }, [
        el('span', {class: 'subject-icon'}, category.icon || 'üì¶'),
        el('h3', {class: 'subject-title'}, category.title),
        el('p', {class: 'subject-subtitle'}, category.subtitle || ''),
        el('span', {class: 'subject-count'}, `${resourceCount} recursos`)
      ]);
    }

    function renderSubjectsOverview() {
      $subjectsOverview.innerHTML = '';
      const list = DATA.categories
        .filter(c => c.visible !== false)
        .filter(c => !homeQuery || c.title.toLowerCase().includes(homeQuery) || c.id.includes(homeQuery));
      list.forEach(category => {
        $subjectsOverview.appendChild(renderSubjectCard(category));
      });
    }

    /* ============================
       RENDER DETALLE
       ============================ */
    function renderResource(resource) {
      return el('a', {
        href: resource.url, target: '_blank', rel: 'noopener noreferrer', class: 'resource-link'
      }, [
        el('div', {class: 'resource-text'}, [
          el('div', {class: 'resource-title'}, resource.title),
          el('div', {class: 'resource-description'}, resource.description || '')
        ])
      ]);
    }

    function renderTopic(topic) {
      // aplicar filtro de b√∫squeda en detalle
      const visibleResources = (topic.resources||[]).filter(resource => {
        if (!filteredResources.length) return true;
        return filteredResources.includes(resource);
      });

      if (visibleResources.length === 0) return null;

      return el('div', {class: 'topic-section'}, [
        el('h3', {class: 'topic-title'}, topic.title),
        el('div', {class: 'resources-grid'}, visibleResources.map(renderResource))
      ]);
    }

    function renderSubjectDetail(category) {
      $detailIcon.textContent = category.icon || 'üì¶';
      $detailTitleText.textContent = category.title;
      $detailSubtitleText.textContent = category.subtitle || '';

      $topicsContainer.innerHTML = '';
      (category.topics || []).forEach(topic => {
        const t = renderTopic(topic);
        if (t) $topicsContainer.appendChild(t);
      });

      if ($topicsContainer.children.length === 0) {
        $topicsContainer.appendChild(
          el('div', {class: 'topic-section', style: 'text-align:center;color:var(--text-light);padding:2rem;'}, [
            el('h3', {}, 'üîç No hay recursos visibles'),
            el('p', {}, 'Revisa el buscador o la visibilidad en recursos.txt')
          ])
        );
      }
    }

    /* ============================
       NAVEGACI√ìN
       ============================ */
    function showSubjectDetail(category) {
      currentView = 'detail';
      currentSubject = category;
      filteredResources = [];
      $searchInput.value = '';
      document.getElementById('home-search').style.display = 'none';
      $subjectsOverview.style.display = 'none';
      $subjectDetail.style.display = 'block';
      renderSubjectDetail(category);
      history.pushState({view:'detail', id: category.id}, '', '#'+category.id);
      window.scrollTo({top:0,behavior:'smooth'});
    }

    function showSubjectsOverview(pushHist=true) {
      currentView = 'overview';
      currentSubject = null;
      filteredResources = [];
      $searchInput.value = '';
      document.getElementById('home-search').style.display = 'block';
      $subjectDetail.style.display = 'none';
      $subjectsOverview.style.display = 'grid';
      if (pushHist) history.pushState({view:'overview'}, '', '#');
      document.querySelector('.hero')?.scrollIntoView({behavior:'smooth'});
    }

    window.onpopstate = (e)=>{
      const state = e.state || {view:'overview'};
      if(state.view === 'detail' && state.id){
        const cat = DATA.categories.find(c=>c.id===state.id);
        if (cat) showSubjectDetail(cat);
      } else {
        showSubjectsOverview(false);
      }
    };

    /* ============================
       B√öSQUEDAS
       ============================ */
    function searchResourcesDetail(query) {
      if (!currentSubject) return;
      const q = query.toLowerCase().trim();
      if (!q) {
        filteredResources = [];
        renderSubjectDetail(currentSubject);
        return;
      }
      filteredResources = [];
      currentSubject.topics?.forEach(topic => {
        topic.resources?.forEach(resource => {
          const t = (resource.title||'').toLowerCase();
          const d = (resource.description||'').toLowerCase();
          if (t.includes(q) || d.includes(q)) filteredResources.push(resource);
        });
      });
      renderSubjectDetail(currentSubject);
    }

    /* ============================
       CARGA DE DATOS
       ============================ */
    async function initDataFromRecursos() {
      try {
        const res = await fetch('./recursos.txt', { cache: 'no-cache' });
        if (!res.ok) throw new Error(res.status + ' ' + res.statusText);
        const raw = await res.text();
        const plain = stripRTF(raw);
        const parsed = parseRecursos(plain);
        DATA = mergeDefaultsWithParsed(parsed);
      } catch (e) {
        console.warn('No se pudo cargar recursos.txt. Se muestran solo las 9 materias con Tema 1 vac√≠o.', e);
        // base m√≠nima con Tema 1 vac√≠o
        DATA = {
          categories: DEFAULT_CATEGORIES.map(c=>({
            ...c,
            topics:[{ title:'Tema 1', visible:true, resources:[] }]
          }))
        };
      }
    }

    /* ============================
       INICIALIZACI√ìN
       ============================ */
    function setupEventListeners() {
      $backButton.addEventListener('click', ()=> showSubjectsOverview());
      $searchInput.addEventListener('input', (e)=> searchResourcesDetail(e.target.value));
      $homeSearchInput.addEventListener('input', (e)=>{
        homeQuery = e.target.value.toLowerCase().trim();
        renderSubjectsOverview();
      });
      document.addEventListener('keydown', (e)=>{
        if (e.key === 'Escape'){
          if (currentView === 'detail') showSubjectsOverview();
          else if (currentView === 'overview' && $homeSearchInput.value) {
            $homeSearchInput.value=''; homeQuery=''; renderSubjectsOverview();
          }
        }
      });
    }

    async function init() {
      await initDataFromRecursos();
      updateStats();
      renderSubjectsOverview();
      setupEventListeners();

      // abrir por hash si procede
      const hash = location.hash.replace('#','').trim();
      if (hash) {
        const cat = DATA.categories.find(c => c.id === hash);
        if (cat) showSubjectDetail(cat);
      } else {
        history.replaceState({view:'overview'}, '', '#');
      }
    }

    init();
  </script>
</body>
</html>
